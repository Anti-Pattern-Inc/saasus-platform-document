"use strict";(self.webpackChunksaasus_platform_document=self.webpackChunksaasus_platform_document||[]).push([[8104],{23177:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/implementation-of-authorization-based-on-tenant-information-2-5457bef714635faf0e4e91ea39aa00d1.png"},27007:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/implementation-of-authorization-based-on-tenant-information-4-c7b7ab2c14b05ef66db786b60fbdb696.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var i=t(96540);const a={},r=i.createContext(a);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(r.Provider,{value:n},e.children)}},65537:(e,n,t)=>{t.d(n,{A:()=>y});var i=t(96540),a=t(34164),r=t(65627),o=t(56347),s=t(50372),l=t(30604),c=t(11861),u=t(78749);function m(e){return i.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function d(e){const{values:n,children:t}=e;return(0,i.useMemo)((()=>{const e=n??function(e){return m(e).map((e=>{let{props:{value:n,label:t,attributes:i,default:a}}=e;return{value:n,label:t,attributes:i,default:a}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function h(e){let{queryString:n=!1,groupId:t}=e;const a=(0,o.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,l.aZ)(r),(0,i.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(a.location.search);n.set(r,e),a.replace({...a.location,search:n.toString()})}),[r,a])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,r=d(e),[o,l]=(0,i.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const i=t.find((e=>e.default))??t[0];if(!i)throw new Error("Unexpected error: 0 tabValues");return i.value}({defaultValue:n,tabValues:r}))),[c,m]=h({queryString:t,groupId:a}),[f,g]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,r]=(0,u.Dv)(t);return[a,(0,i.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:a}),b=(()=>{const e=c??f;return p({value:e,tabValues:r})?e:null})();(0,s.A)((()=>{b&&l(b)}),[b]);return{selectedValue:o,selectValue:(0,i.useCallback)((e=>{if(!p({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);l(e),m(e),g(e)}),[m,g,r]),tabValues:r}}var g=t(9136);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(74848);function j(e){let{className:n,block:t,selectedValue:i,selectValue:o,tabValues:s}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,r.a_)(),u=e=>{const n=e.currentTarget,t=l.indexOf(n),a=s[t].value;a!==i&&(c(n),o(a))},m=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;n=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;n=l[t]??l[l.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},n),children:s.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:i===n?0:-1,"aria-selected":i===n,ref:e=>{l.push(e)},onKeyDown:m,onClick:u,...r,className:(0,a.A)("tabs__item",b.tabItem,r?.className,{"tabs__item--active":i===n}),children:t??n},n)}))})}function w(e){let{lazy:n,children:t,selectedValue:r}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===r));return e?(0,i.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,i.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function v(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,a.A)("tabs-container",b.tabList),children:[(0,x.jsx)(j,{...n,...e}),(0,x.jsx)(w,{...n,...e})]})}function y(e){const n=(0,g.A)();return(0,x.jsx)(v,{...e,children:m(e.children)},String(n))}},73206:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/implementation-of-authorization-based-on-tenant-information-5-209eeac8f847aa747997d4e8e8b79e94.png"},74994:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/implementation-of-authorization-based-on-tenant-information-1-2e4d2fc856c3138e55898bfe8e5d9e73.png"},79329:(e,n,t)=>{t.d(n,{A:()=>o});t(96540);var i=t(34164);const a={tabItem:"tabItem_Ymn6"};var r=t(74848);function o(e){let{children:n,hidden:t,className:o}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,i.A)(a.tabItem,o),hidden:t,children:n})}},85801:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>i,toc:()=>m});const i=JSON.parse('{"id":"tutorial/implementation-of-authorization-based-on-tenant-information","title":"Implementation of authorization based on tenant information","description":"Implementation of Authorization","source":"@site/versioned_docs/version-1.11/tutorial/implementation-of-authorization-based-on-tenant-information.mdx","sourceDirName":"tutorial","slug":"/tutorial/implementation-of-authorization-based-on-tenant-information","permalink":"/docs/tutorial/implementation-of-authorization-based-on-tenant-information","draft":false,"unlisted":false,"tags":[],"version":"1.11","frontMatter":{"title":"Implementation of authorization based on tenant information","slug":"implementation-of-authorization-based-on-tenant-information","excerpt":"","hidden":false,"pagination_prev":"tutorial/manage-rate-plans/manage-rate-plans","createdAt":"Fri Jan 20 2023 01:47:33 GMT+0000 (Coordinated Universal Time)","updatedAt":"Thu Dec 07 2023 01:25:35 GMT+0000 (Coordinated Universal Time)"},"sidebar":"tutorialSidebar","previous":{"title":"Manage Rate Plans","permalink":"/docs/tutorial/manage-rate-plans/manage-rate-plans"},"next":{"title":"Lastly","permalink":"/docs/tutorial/summarize"}}');var a=t(74848),r=t(28453),o=t(65537),s=t(79329);const l={title:"Implementation of authorization based on tenant information",slug:"implementation-of-authorization-based-on-tenant-information",excerpt:"",hidden:!1,pagination_prev:"tutorial/manage-rate-plans/manage-rate-plans",createdAt:"Fri Jan 20 2023 01:47:33 GMT+0000 (Coordinated Universal Time)",updatedAt:"Thu Dec 07 2023 01:25:35 GMT+0000 (Coordinated Universal Time)"},c=void 0,u={},m=[{value:"Implementation of Authorization",id:"implementation-of-authorization",level:2},{value:"Implementation of comment limits based on pricing plan measurement unit",id:"implementation-of-comment-limits-based-on-pricing-plan-measurement-unit",level:3}];function d(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"implementation-of-authorization",children:"Implementation of Authorization"}),"\n",(0,a.jsx)(n.h3,{id:"implementation-of-comment-limits-based-on-pricing-plan-measurement-unit",children:"Implementation of comment limits based on pricing plan measurement unit"}),"\n",(0,a.jsx)(n.p,{children:"Let's modify the previous sample application and implement the first step of authorization."}),"\n",(0,a.jsx)(n.p,{children:"With the SaaS Platform settings so far, which user is logged in, which tenant the user belongs to, what role the user has, which price plan is selected by that tenant, and what menu can be used? can be obtained from the application. We will use that information to limit the application."}),"\n",(0,a.jsx)(n.p,{children:'For now, focus on "Comments", which is one of the measurement units in the pricing plans.'}),"\n",(0,a.jsx)(n.p,{children:"Earlier, we set a different upper limit for the number of comments for each price plan."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"10 comments limit on Free plan"}),"\n",(0,a.jsx)(n.li,{children:"100 comments limit on Basic plan"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Now, get the maximum number associated with this pricing plan for each tenant and set a limit."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["For Laravel, let\u2019s modify the ",(0,a.jsx)(n.code,{children:"post"})," method in ",(0,a.jsx)(n.code,{children:"api/app/Http/Controllers/MessageController.php"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["For Express, let\u2019s add an ",(0,a.jsx)(n.code,{children:"import"})," statement to ",(0,a.jsx)(n.code,{children:"api/controllers/chat.ts"})," and modify the ",(0,a.jsx)(n.code,{children:"postChats"})," method."]}),"\n"]}),"\n",(0,a.jsxs)(o.A,{children:[(0,a.jsx)(s.A,{value:"php",label:"Laravel (PHP)",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"   public function post(Request $request)\n   {\n        $validated = $request->validate([\n            'message' => 'required|max:255'\n        ]);\n\n        $tenant_id = $request->userinfo['tenants'][0]['id'];\n        $plan_id = $request->userinfo['tenants'][0]['plan_id'];\n\n        // Use the SaaSus SDK to hit the SaaSus API, acquire various information, and use it for judgment\n        $client = new \\AntiPatternInc\\Saasus\\Api\\Client();\n        $pricingApi = $client->getPricingClient();\n        $res = $pricingApi->getPricingPlan($plan_id, $pricingApi::FETCH_RESPONSE);\n        $plan = json_decode($res->getBody(), true);\n\n        // use metering meter, comment_count\n        $meteringUnitName = \"comment_count\";\n        $res = $pricingApi->getMeteringUnitDateCountByTenantIdAndUnitNameToday($tenant_id, $meteringUnitName, $pricingApi::FETCH_RESPONSE);\n        // This time, treat it as the maximum number of comments per day\n        $count = json_decode($res->getBody(), true);\n\n        $upper = \\AntiPatternInc\\Saasus\\Api\\Lib::findUpperCountByMeteringUnitName($plan, $meteringUnitName);\n\n        // Disable posting if the number of comments exceeds the maximum number of comments for the current contracted price plan\n        if ($count['count'] < $upper || $upper === 0) {\n            $message = Message::create([\n                'tenant_id' => $tenant_id,\n                'user_id' => $request->userinfo['tenants'][0]['user_attribute']['username'],\n                'message' => $request->message,\n            ]);\n            // add 1 to the number of comments in the metering API\n            $param = new \\AntiPatternInc\\Saasus\\Sdk\\Pricing\\Model\\UpdateMeteringUnitTimestampCountNowParam();\n            $param->setMethod('add');\n            $param->setCount(1);\n            $res = $pricingApi->updateMeteringUnitTimestampCountNow($request->userinfo['tenants'][0]['id'], $meteringUnitName, $param, $pricingApi::FETCH_RESPONSE);\n        }\n\n        $request->session()->regenerateToken();\n        return redirect()->route('board');\n   }\n"})})}),(0,a.jsx)(s.A,{value:"typescript",label:"Express (TS)",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'import { UpdateMeteringUnitTimestampCountNowParam } from "saasus-sdk/dist/generated/Pricing";\nimport { findUpperCountByMeteringUnitName, PricingClient } from "saasus-sdk";\n\n// Other code omitted\n\nconst postChats = async (req: Request, res: Response) => {\n  const mes = req.body.message;\n  const tenantId = req.userInfo?.tenants[0].id || "";\n  const planId = req.userInfo?.tenants[0].plan_id || "";\n  const userName =\n    req.userInfo?.tenants[0].user_attribute.username;\n  try {\n    const pricingClient = new PricingClient();\n    const pricingPlan = await pricingClient.pricingPlansApi.getPricingPlan(\n      planId\n    );\n\n    // use metering meter, comment_count\n    const meteringUnitName = "comment_count";\n    const meteringUnitCountData =\n      await pricingClient.meteringApi.getMeteringUnitDateCountByTenantIdAndUnitNameToday(\n        tenantId,\n        meteringUnitName\n      );\n    \n    // This time, treat it as the maximum number of comments per day\n    const upper = findUpperCountByMeteringUnitName(\n      pricingPlan.data,\n      meteringUnitName\n    );\n\n    // Disable posting if the number of comments exceeds the maximum number of comments for the current contracted price plan\n    if (meteringUnitCountData.data.count < upper || upper === 0) {\n      await db.Messages.create({\n        tenant_id: tenantId,\n        user_id: userName,\n        message: mes,\n      });\n\n      // add 1 to the number of comments in the metering API\n      let param: UpdateMeteringUnitTimestampCountNowParam = {\n        method: "add",\n        count: 1,\n      };\n      const res =\n        await pricingClient.meteringApi.updateMeteringUnitTimestampCountNow(\n          tenantId,\n          meteringUnitName,\n          param\n        );\n    }\n  } catch (error) {\n    console.error(error);\n  }\n  res.redirect("/chat");\n};\n'})})})]}),"\n",(0,a.jsx)(n.p,{children:"In addition to the previous code, check the maximum number of comments based on the comment count target meter \u201ccomment_count\u201d."}),"\n",(0,a.jsx)(n.p,{children:"Earlier, the measurement unit is set based on \u201ccomment_count\u201d in any price plan measurement unit as shown in the screen below."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(74994).A+"",width:"1440",height:"846"})}),"\n",(0,a.jsx)(n.p,{children:"In the function,"}),"\n",(0,a.jsxs)(n.p,{children:["Get the ",(0,a.jsx)(n.strong,{children:"price plan"})," associated with the tenant,"]}),"\n",(0,a.jsxs)(n.p,{children:["Get the ",(0,a.jsx)(n.strong,{children:"current value"})," of the target meter \u201ccomment_count\u201d,"]}),"\n",(0,a.jsxs)(n.p,{children:["Checking the ",(0,a.jsx)(n.strong,{children:"upper limit"}),' of the upper limit "comment_count" associated with the pricing plan']}),"\n",(0,a.jsx)(n.p,{children:"and if the current value does not exceed the upper limit,"}),"\n",(0,a.jsx)(n.p,{children:"Do the comment writing process as usual,"}),"\n",(0,a.jsxs)(n.p,{children:["Add 1 to the ",(0,a.jsx)(n.strong,{children:"current value"}),' of the target meter "comment_count" and update.']}),"\n",(0,a.jsx)(n.p,{children:"By doing this, it is possible to prevent writing when the upper limit for each pricing plan is exceeded."}),"\n",(0,a.jsx)(n.p,{children:"In order to simplify the process this time, the program will be limited to stopping additional comments once the maximum number is reached. However, in a real case scenario an error message or a message prompting an upsell should be displayed."}),"\n",(0,a.jsxs)(n.p,{children:["Depending on the function, if it is completely stopped at the upper limit, the value of SaaS may be impaired.",(0,a.jsx)(n.br,{}),"\n","For example, if we put an upper limit on comments, and it becomes impossible to write completely there, this will not work as a chat application.",(0,a.jsx)(n.br,{}),"\n","Resulting in this SaaS may going unused until this meter is reset, also taking the risk that there is also the possibility that it will never be used again.",(0,a.jsx)(n.br,{}),"\n","Therefore, instead of stopping comments completely, it is important to prevent the value of this SaaS itself from being lost, such as issuing a warning about the limit, or adjusting the storage period."]}),"\n",(0,a.jsx)(n.p,{children:"Since this is a tutorial, it is completely unwritable. Now, check to see if writing is not possible at the upper limit."}),"\n",(0,a.jsx)(n.p,{children:"First, run init.sh to clean up the application, just like when we first initialized the application."}),"\n",(0,a.jsxs)(n.p,{children:["Then, set the Free plan for Tenant 1, log in with ",(0,a.jsx)(n.a,{href:"mailto:user1-1@example.com",children:"user1-1@example.com"}),", and write 10 or more items."]}),"\n",(0,a.jsx)(n.p,{children:"This shows that tenant 1 can write a maximum of 10 records."}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["This time, the implementation only counts writings after the meter is set. ",(0,a.jsx)("br",{})," If you want to take writings before the setting into account, you can also update the meter value directly."]})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(23177).A+"",width:"1440",height:"861"})}),"\n",(0,a.jsxs)(n.p,{children:["Next, log in with user ",(0,a.jsx)(n.a,{href:"mailto:user2-1@example.com",children:"user2-1@example.com"})," in tenant 2 and write 10 or more items."]}),"\n",(0,a.jsx)(n.p,{children:"Since the upper limit is 100 here, you should have been able to write more than 10."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(98976).A+"",width:"1440",height:"861"})}),"\n",(0,a.jsxs)(n.p,{children:["Furthermore, assuming that tenant 1 has upgraded the plan, change the setting from the Free plan to the Basic plan, log in again with ",(0,a.jsx)(n.a,{href:"mailto:user1-1@example.com",children:"user1-1@example.com"}),", and write 10 or more items. prize.",(0,a.jsx)(n.br,{}),"\n","(It takes about 5 minutes to reflect the changed settings.)"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(27007).A+"",width:"1440",height:"861"})}),"\n",(0,a.jsx)(n.p,{children:"This shows that user1-1 can write more than ten items."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(73206).A+"",width:"2880",height:"1263"})}),"\n",(0,a.jsx)(n.p,{children:"Using this method it is now possible to meter and limit according to the pricing plan."})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},98976:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/implementation-of-authorization-based-on-tenant-information-3-6eb37f79321db40e2eba520c0b2d321a.png"}}]);