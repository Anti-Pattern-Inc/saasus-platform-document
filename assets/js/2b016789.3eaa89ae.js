"use strict";(self.webpackChunksaasus_platform_document=self.webpackChunksaasus_platform_document||[]).push([[784],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>h});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),p=u(n),d=i,h=p["".concat(s,".").concat(d)]||p[d]||c[d]||r;return n?a.createElement(h,o(o({ref:t},m),{},{components:n})):a.createElement(h,o({ref:t},m))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(67294),i=n(86010);const r={tabItem:"tabItem_Ymn6"};function o(e){let{children:t,hidden:n,className:o}=e;return a.createElement("div",{role:"tabpanel",className:(0,i.Z)(r.tabItem,o),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>y});var a=n(87462),i=n(67294),r=n(86010),o=n(12466),l=n(16550),s=n(91980),u=n(67392),m=n(50012);function p(e){return function(e){return i.Children.map(e,(e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:i}}=e;return{value:t,label:n,attributes:a,default:i}}))}function c(e){const{values:t,children:n}=e;return(0,i.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const a=(0,l.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s._X)(r),(0,i.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(a.location.search);t.set(r,e),a.replace({...a.location,search:t.toString()})}),[r,a])]}function f(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,r=c(e),[o,l]=(0,i.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:r}))),[s,u]=h({queryString:n,groupId:a}),[p,f]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,r]=(0,m.Nk)(n);return[a,(0,i.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:a}),b=(()=>{const e=s??p;return d({value:e,tabValues:r})?e:null})();(0,i.useLayoutEffect)((()=>{b&&l(b)}),[b]);return{selectedValue:o,selectValue:(0,i.useCallback)((e=>{if(!d({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),f(e)}),[u,f,r]),tabValues:r}}var b=n(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function k(e){let{className:t,block:n,selectedValue:l,selectValue:s,tabValues:u}=e;const m=[],{blockElementScrollPositionUntilNextRender:p}=(0,o.o5)(),c=e=>{const t=e.currentTarget,n=m.indexOf(t),a=u[n].value;a!==l&&(p(t),s(a))},d=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=m.indexOf(e.currentTarget)+1;t=m[n]??m[0];break}case"ArrowLeft":{const n=m.indexOf(e.currentTarget)-1;t=m[n]??m[m.length-1];break}}t?.focus()};return i.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:o}=e;return i.createElement("li",(0,a.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>m.push(e),onKeyDown:d,onClick:c},o,{className:(0,r.Z)("tabs__item",g.tabItem,o?.className,{"tabs__item--active":l===t})}),n??t)})))}function w(e){let{lazy:t,children:n,selectedValue:a}=e;const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=r.find((e=>e.props.value===a));return e?(0,i.cloneElement)(e,{className:"margin-top--md"}):null}return i.createElement("div",{className:"margin-top--md"},r.map(((e,t)=>(0,i.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function v(e){const t=f(e);return i.createElement("div",{className:(0,r.Z)("tabs-container",g.tabList)},i.createElement(k,(0,a.Z)({},e,t)),i.createElement(w,(0,a.Z)({},e,t)))}function y(e){const t=(0,b.Z)();return i.createElement(v,(0,a.Z)({key:String(t)},e))}},21676:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>m,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>u,toc:()=>p});var a=n(87462),i=(n(67294),n(3905)),r=n(74866),o=n(85162);const l={title:"Implementation of authorization based on tenant information",slug:"implementation-of-authorization-based-on-tenant-information",excerpt:"",hidden:!1,createdAt:"Fri Jan 20 2023 01:47:33 GMT+0000 (Coordinated Universal Time)",updatedAt:"Thu Dec 07 2023 01:25:35 GMT+0000 (Coordinated Universal Time)"},s=void 0,u={unversionedId:"tutorial/implementation-of-authorization-based-on-tenant-information",id:"tutorial/implementation-of-authorization-based-on-tenant-information",title:"Implementation of authorization based on tenant information",description:"Implementation of Authorization",source:"@site/docs/tutorial/implementation-of-authorization-based-on-tenant-information.mdx",sourceDirName:"tutorial",slug:"/tutorial/implementation-of-authorization-based-on-tenant-information",permalink:"/docs/next/tutorial/implementation-of-authorization-based-on-tenant-information",draft:!1,tags:[],version:"current",frontMatter:{title:"Implementation of authorization based on tenant information",slug:"implementation-of-authorization-based-on-tenant-information",excerpt:"",hidden:!1,createdAt:"Fri Jan 20 2023 01:47:33 GMT+0000 (Coordinated Universal Time)",updatedAt:"Thu Dec 07 2023 01:25:35 GMT+0000 (Coordinated Universal Time)"},sidebar:"tutorialSidebar",previous:{title:"Setting measurement units, feature menus, and pricing plans",permalink:"/docs/next/tutorial/manage-rate-plans/setting-measurement-units-function-menus-and-price-plans"},next:{title:"Implementation to Next.js (SPA) based application",permalink:"/docs/next/tutorial/implementation-to-nextjs-spa-based-application"}},m={},p=[{value:"Implementation of Authorization",id:"implementation-of-authorization",level:2},{value:"Implementation of comment limits based on pricing plan measurement unit",id:"implementation-of-comment-limits-based-on-pricing-plan-measurement-unit",level:3}],c={toc:p},d="wrapper";function h(e){let{components:t,...l}=e;return(0,i.kt)(d,(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"implementation-of-authorization"},"Implementation of Authorization"),(0,i.kt)("h3",{id:"implementation-of-comment-limits-based-on-pricing-plan-measurement-unit"},"Implementation of comment limits based on pricing plan measurement unit"),(0,i.kt)("p",null,"Let's modify the previous sample application and implement the first step of authorization."),(0,i.kt)("p",null,"With the SaaS Platform settings so far, which user is logged in, which tenant the user belongs to, what role the user has, which price plan is selected by that tenant, and what menu can be used? can be obtained from the application. We will use that information to limit the application."),(0,i.kt)("p",null,'For now, focus on "Comments", which is one of the measurement units in the pricing plans.'),(0,i.kt)("p",null,"Earlier, we set a different upper limit for the number of comments for each price plan."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"10 comments limit on Free plan"),(0,i.kt)("li",{parentName:"ul"},"100 comments limit on Basic plan"),(0,i.kt)("li",{parentName:"ul"},"No limit on Advanced plan and above")),(0,i.kt)("p",null,"Now, get the maximum number associated with this pricing plan for each tenant and set a limit."),(0,i.kt)("p",null,"Rewrite the post method of api/app/Http/Controllers/MessageController.php as follows."),(0,i.kt)(r.Z,{mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"php",label:"PHP",default:!0,mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"   public function post(Request $request)\n   {\n        $validated = $request->validate([\n            'message' => 'required|max:255'\n        ]);\n\n        $tenant_id = $request->userinfo['tenants'][0]['id'];\n        $plan_id = $request->userinfo['tenants'][0]['plan_id'];\n\n        // Use the SaaSus SDK to hit the SaaSus API, acquire various information, and use it for judgment\n        $client = new \\AntiPatternInc\\Saasus\\Api\\Client();\n        $pricingApi = $client->getPricingClient();\n        $res = $pricingApi->getPricingPlan($plan_id, $pricingApi::FETCH_RESPONSE);\n        $plan = json_decode($res->getBody(), true);\n\n        // use metering meter, comment_count\n        $meteringUnitName = \"comment_count\";\n        $res = $pricingApi->getMeteringUnitDateCountByTenantIdAndUnitNameToday($tenant_id, $meteringUnitName, $pricingApi::FETCH_RESPONSE);\n        // This time, treat it as the maximum number of comments per day\n        $count = json_decode($res->getBody(), true);\n\n        $upper = \\AntiPatternInc\\Saasus\\Api\\Lib::findUpperCountByMeteringUnitName($plan, $meteringUnitName);\n\n        // Disable posting if the number of comments exceeds the maximum number of comments for the current contracted price plan\n        if ($count['count'] < $upper || $upper === 0) {\n            $message = Message::create([\n                'tenant_id' => $tenant_id,\n                'user_id' => $request->userinfo['tenants'][0]['user_attribute']['username'],\n                'message' => $request->message,\n            ]);\n            // add 1 to the number of comments in the metering API\n            $param = new \\AntiPatternInc\\Saasus\\Sdk\\Pricing\\Model\\UpdateMeteringUnitTimestampCountNowParam();\n            $param->setMethod('add');\n            $param->setCount(1);\n            $res = $pricingApi->updateMeteringUnitTimestampCountNow($request->userinfo['tenants'][0]['id'], $meteringUnitName, $param, $pricingApi::FETCH_RESPONSE);\n        }\n\n        $request->session()->regenerateToken();\n        return redirect()->route('board');\n   }\n")))),(0,i.kt)("p",null,"In addition to the previous code, check the maximum number of comments based on the comment count target meter \u201ccomment_count\u201d."),(0,i.kt)("p",null,"Earlier, the measurement unit is set based on \u201ccomment_count\u201d in any price plan measurement unit as shown in the screen below."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(78045).Z,width:"975",height:"760"})),(0,i.kt)("p",null,"In the function,"),(0,i.kt)("p",null,"Get the ",(0,i.kt)("strong",{parentName:"p"},"price plan")," associated with the tenant,"),(0,i.kt)("p",null,"Get the ",(0,i.kt)("strong",{parentName:"p"},"current value")," of the target meter \u201ccomment_count\u201d,"),(0,i.kt)("p",null,"Checking the ",(0,i.kt)("strong",{parentName:"p"},"upper limit"),' of the upper limit "comment_count" associated with the pricing plan'),(0,i.kt)("p",null,"and if the current value does not exceed the upper limit,"),(0,i.kt)("p",null,"Do the comment writing process as usual,"),(0,i.kt)("p",null,"Add 1 to the ",(0,i.kt)("strong",{parentName:"p"},"current value"),' of the target meter "comment_count" and update.'),(0,i.kt)("p",null,"By doing this, it is possible to prevent writing when the upper limit for each pricing plan is exceeded."),(0,i.kt)("p",null,"In order to simplify the process this time, the program will be limited to stopping additional comments once the maximum number is reached. However, in a real case scenario an error message or a message prompting an upsell should be displayed."),(0,i.kt)("p",null,"Depending on the function, if it is completely stopped at the upper limit, the value of SaaS may be impaired.",(0,i.kt)("br",{parentName:"p"}),"\n","For example, if we put an upper limit on comments, and it becomes impossible to write completely there, this will not work as a chat application.",(0,i.kt)("br",{parentName:"p"}),"\n","Resulting in this SaaS may going unused until this meter is reset, also taking the risk that there is also the possibility that it will never be used again.",(0,i.kt)("br",{parentName:"p"}),"\n","Therefore, instead of stopping comments completely, it is important to prevent the value of this SaaS itself from being lost, such as issuing a warning about the limit, or adjusting the storage period."),(0,i.kt)("p",null,"Since this is a tutorial, it is completely unwritable. Now, check to see if writing is not possible at the upper limit!"),(0,i.kt)("p",null,"First, run init.sh to clean up the application, just like when we first initialized the application."),(0,i.kt)("p",null,"Then, set the Free plan for Tenant 1, log in with ",(0,i.kt)("a",{parentName:"p",href:"mailto:user1-1@example.com"},"user1-1@example.com"),", and write 10 or more items."),(0,i.kt)("p",null,"This shows that tenant 1 can write a maximum of 10 records."),(0,i.kt)("img",{src:"/img/tutorial/implementation-of-authorization-based-on-tenant-information/implementation-of-authorization-based-on-tenant-information-2.png",width:"400"}),(0,i.kt)("p",null,"Next, log in with user ",(0,i.kt)("a",{parentName:"p",href:"mailto:user2-1@example.com"},"user2-1@example.com")," in tenant 2 and write 10 or more items."),(0,i.kt)("p",null,"Since the upper limit is 100 here, you should have been able to write more than 10."),(0,i.kt)("img",{src:"/img/tutorial/implementation-of-authorization-based-on-tenant-information/implementation-of-authorization-based-on-tenant-information-3.png",width:"400"}),(0,i.kt)("p",null,"Furthermore, assuming that tenant 1 has upgraded the plan, change the setting from the Free plan to the Basic plan, log in again with ",(0,i.kt)("a",{parentName:"p",href:"mailto:user1-1@example.com"},"user1-1@example.com"),", and write 10 or more items. prize.",(0,i.kt)("br",{parentName:"p"}),"\n","(It takes about 5 minutes to reflect the changed settings.)"),(0,i.kt)("img",{src:"/img/tutorial/implementation-of-authorization-based-on-tenant-information/implementation-of-authorization-based-on-tenant-information-4.png",width:"400"}),(0,i.kt)("p",null,"This shows that user1-1 can write more than ten items."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(27139).Z,width:"2995",height:"1313"})),(0,i.kt)("p",null,"Using this method it is now possible to meter and limit according to the pricing plan!"),(0,i.kt)("p",null,"Up to this point, we have implemented Blade-based applications, but finally, how should we implement Next.js (API-based SPA)? Let's continue."))}h.isMDXComponent=!0},78045:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/implementation-of-authorization-based-on-tenant-information-1-60719708c7281c8dbfcd9d1f3819c26b.png"},27139:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/implementation-of-authorization-based-on-tenant-information-5-7c98e325564d98456ff7152ce4b2f3e0.png"}}]);