---
title: "Implementation using SaaSus Platform (Serverless)"
slug: "implementing-authentication-using-saasus-serverless"
excerpt: "Implementation guide for SaaS applications using SaaSus Platform's serverless approach"
hidden: false
createdAt: "Mon Jul 31 2023 03:24:01 GMT+0000 (Coordinated Universal Time)"
updatedAt: "Thu Dec 07 2023 01:25:35 GMT+0000 (Coordinated Universal Time)"
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

This is an implementation example of a SaaS application using SaaSus Platform's serverless approach.
You can learn while running the necessary features for SaaS, such as authentication, tenant management, and user management, in a serverless environment.

### Key Features
- **Serverless Architecture**: Utilizing serverless services like AWS Lambda
- **React + TypeScript**: Using React for the frontend
- **JWT Authentication**: Token management in browser's local storage
- **CDK Support**: Infrastructure construction using AWS CDK

## Implementation Approach

This sample application is implemented as a **serverless version**.

### Serverless Version Features

This implementation approach uses a serverless backend with the following characteristics:
- Store the token (JWT), which is the authentication information for the SaaSus Platform, in the browser's local storage
- SaaS Platform users authenticate themselves using the JWT
- The frontend is implemented with React
- The backend is implemented using serverless services such as Lambda

:::info
**Frontend Deployment**
In this sample application, the frontend runs in a local environment (`http://localhost:3000`). In actual deployment, the frontend can also be deployed to static hosting services like S3 + CloudFront.
:::

## Implemented Screens and Features

### Authentication Screens

#### [`Callback.tsx`](https://github.com/saasus-platform/implementation-sample-front-react-serverless/blob/main/src/pages/Callback.tsx) - Post-Authentication Redirect Screen

- Receives authentication information from SaaSus Platform
- Saves JWT token to local storage
- Automatically redirects to appropriate screen based on user role
- â€»Not displayed to users as it's a redirect process

#### [`SelfSignUp.tsx`](https://github.com/saasus-platform/implementation-sample-front-react-serverless/blob/main/src/pages/SelfSignUp.tsx) - Self-Signup Screen

- New users create their own tenant
- Tenant name input
- User and tenant attribute configuration
- Input fields for different attribute types (string, number, boolean, date)

### User and Tenant Management Screens

#### [`TenantList.tsx`](https://github.com/saasus-platform/implementation-sample-front-react-serverless/blob/main/src/pages/TenantList.tsx) - Tenant List Screen

- For users belonging to multiple tenants
- Display of tenant attributes (configured/unconfigured status)
- Navigation to user list screen for each tenant

#### [`UserPage.tsx`](https://github.com/saasus-platform/implementation-sample-front-react-serverless/blob/main/src/pages/UserPage.tsx) - User List Screen (Main Screen)

- **Logged-in User Information Display**: Tenant name, name, email, role
- **User List Table**: Display all users in the tenant
- **User Attribute Display**: Dynamic display of custom attributes

## Frontend Implementation

### Post-Authentication Redirect Screen (Callback)

After logging in from the login screen generated by the SaaSus Platform, the URL set as the post-authentication redirect will be called.

To test using this implementation sample, please set the redirect to `http://localhost:3000/callback`.

![](/img/part-6/implementation-guide/implementing-authentication-using-saasus-serverless/image-02.png)

After authentication, a temporary code (code=xxxxx) necessary for retrieving authentication information is passed in the query parameters of the redirect URL. Please implement a process to retrieve the JWT using this temporary code and save the JWT to local storage.

#### Post-Authentication Screen Transition Logic

The sample app checks user information after JWT retrieval and transitions to the appropriate screen using the following logic:

1. **No tenant affiliation**: Transition to self-signup screen
2. **Multiple tenant affiliations**: Transition to tenant list screen
3. **Single tenant affiliation**: Transition to user list screen (main screen)

This transition logic ensures that the optimal screen is displayed based on the user's situation.

### Self-Signup Screen

It is necessary to check if the user is logged in, so call the user information retrieval API to confirm login status.  
Use the JWT stored in local storage when making API calls.  
You can confirm that the user is logged in if user information is retrievable.

### Tenant List Screen

This screen is for users belonging to multiple tenants. It displays a list of tenants the user belongs to and provides navigation to the user list screen for each tenant.

### User List Screen (Top Page)

The user list screen displays information about authenticated users and all users within the tenant.

## Backend Implementation

### JWT Retrieval API

The implementation of this API is included in the following links.
Please search for the function name or definition to find the relevant section.

- **TypeScript (Lambda)**: [`credentials.ts`](https://github.com/saasus-platform/implementation-sample-api-lambda/blob/main/lambda/auth/credentials.ts)

<Tabs>
<TabItem value="typescript" label="TypeScript">

```typescript
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { AuthClient } from 'saasus-sdk';
import {
  createSuccessResponse,
  createErrorResponse,
  createOptionsResponse,
  getQueryParameter,
  getHttpMethod,
  logRequest,
  logError,
  logSuccess,
} from '../../shared/utils';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  logRequest('credentials', event);

  // Handle OPTIONS requests (preflight)
  if (getHttpMethod(event) === 'OPTIONS') {
    return createOptionsResponse();
  }

  // Only allow GET method
  if (getHttpMethod(event) !== 'GET') {
    return createErrorResponse('Method not allowed', 405);
  }

  try {
    // Get authorization code from query parameters
    const code = getQueryParameter(event.queryStringParameters, 'code');
    if (!code) {
      logError('credentials', 'Authorization code not found in query parameters');
      return createErrorResponse('Authorization code not found', 400);
    }

    // Initialize SaaSus authentication client
    const authClient = new AuthClient();
    
    // Get authentication information
    const credentialsResponse = await authClient.credentialApi.getAuthCredentials(code);

    const credentials = credentialsResponse.data;
    logSuccess('credentials', 'Successfully retrieved credentials');

    // Add Set-Cookie header to response
    const response = createSuccessResponse(credentials);
    
    // Set refresh token as cookie
    if (credentials.refresh_token) {
      const maxAge = 30 * 24 * 60 * 60; // 30 days
      response.headers = {
        ...response.headers,
        'Set-Cookie': `SaaSusRefreshToken=${credentials.refresh_token}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=${maxAge}`,
      };
    }

    return response;
  } catch (error) {
    logError('credentials', error);
    return createErrorResponse(
      'Failed to get credentials',
      500,
      error instanceof Error ? error.message : 'Unknown error'
    );
  }
};
```

</TabItem>
</Tabs>

### User Information Retrieval API

The implementation of this API is included in the following links.
Please search for the function name or definition to find the relevant section.

- **TypeScript (Lambda)**: [`userinfo.ts`](https://github.com/saasus-platform/implementation-sample-api-lambda/blob/main/lambda/auth/userinfo.ts)

<Tabs>
<TabItem value="typescript" label="TypeScript">

```typescript
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { AuthClient } from 'saasus-sdk';
import {
  createSuccessResponse,
  createErrorResponse,
  createOptionsResponse,
  extractTokenFromHeader,
  getHttpMethod,
  logRequest,
  logError,
  logSuccess,
} from '../../shared/utils';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  logRequest('userinfo', event);

  // Handle OPTIONS requests (preflight)
  if (getHttpMethod(event) === 'OPTIONS') {
    return createOptionsResponse();
  }

  // Only allow GET method
  if (getHttpMethod(event) !== 'GET') {
    return createErrorResponse('Method not allowed', 405);
  }

  try {
    // Get token from Authorization header
    const token = extractTokenFromHeader(event.headers);
    if (!token) {
      logError('userinfo', 'No valid authorization header found');
      return createErrorResponse('No valid authorization header found', 401);
    }

    // Initialize SaaSus authentication client
    const authClient = new AuthClient();
    
    // Get user information
    const userInfoResponse = await authClient.userInfoApi.getUserInfo(token);
    const userInfo = userInfoResponse.data;

    logSuccess('userinfo', 'Successfully retrieved user info');
    return createSuccessResponse(userInfo);
  } catch (error) {
    logError('userinfo', error);
    return createErrorResponse(
      'Failed to get user info',
      500,
      error instanceof Error ? error.message : 'Unknown error'
    );
  }
};
```
</TabItem>
</Tabs>

### Self-Signup API

The implementation of this API is included in the following links.
Please search for the function name or definition to find the relevant section.

- **TypeScript (Lambda)**: [`self-sign-up.ts`](https://github.com/saasus-platform/implementation-sample-api-lambda/blob/main/lambda/tenant/self-sign-up.ts)

To confirm that the API request comes from a user logged into the SaaSus Platform, always confirm login by retrieving user information.

The self-signup process is as follows:
Prerequisite) The self-signup user becomes the administrator of the new tenant:

a. Create a tenant  
b. Link the logged-in user to the created tenant  
c. Set the logged-in user as the administrator of the tenant

<Tabs>
<TabItem value="typescript" label="TypeScript">

```typescript
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { AuthClient } from 'saasus-sdk';
import {
  CreateTenantUserParam,
  CreateTenantUserRolesParam,
  TenantProps,
} from 'saasus-sdk/dist/generated/Auth';
import {
  createSuccessResponse,
  createErrorResponse,
  createOptionsResponse,
  parseRequestBody,
  convertAttributeValues,
  getHttpMethod,
  logRequest,
  logError,
  logSuccess,
} from '../../shared/utils';
import { SelfSignUpRequest } from '../../shared/types';
import { getAuthenticatedUserInfo } from '../../shared/auth-utils';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  logRequest('self-sign-up', event);

  // Handle OPTIONS requests (preflight)
  if (getHttpMethod(event) === 'OPTIONS') {
    return createOptionsResponse();
  }

  // Only allow POST method
  if (getHttpMethod(event) !== 'POST') {
    return createErrorResponse('Method not allowed', 405);
  }

  try {
    // Parse request body
    const requestData = parseRequestBody<SelfSignUpRequest>(event.body);
    if (!requestData || !requestData.tenantName) {
      return createErrorResponse('Missing required fields', 400);
    }

    const { tenantName, tenantAttributeValues, userAttributeValues } = requestData;

    // Unified authentication processing
    const userInfo = await getAuthenticatedUserInfo(event.headers);

    // Initialize SaaSus authentication client
    const authClient = new AuthClient();

    // Get and convert tenant attribute information
    const tenantAttributesResponse = await authClient.tenantAttributeApi.getTenantAttributes();
    const tenantAttributes = tenantAttributesResponse.data.tenant_attributes;
    const convertedTenantAttributeValues = convertAttributeValues(
      tenantAttributeValues || {},
      tenantAttributes
    );

    // Create tenant
    const tenantProps: TenantProps = {
      name: tenantName,
      attributes: convertedTenantAttributeValues,
      back_office_staff_email: userInfo.email,
    };

    const createdTenantResponse = await authClient.tenantApi.createTenant(tenantProps);
    const createdTenant = createdTenantResponse.data;
    const tenantId = createdTenant.id;

    // Get and convert user attribute information
    const userAttributesResponse = await authClient.userAttributeApi.getUserAttributes();
    const userAttributes = userAttributesResponse.data.user_attributes;
    const convertedUserAttributeValues = convertAttributeValues(
      userAttributeValues || {},
      userAttributes
    );

    // Create tenant user registration parameters
    const createTenantUserParam: CreateTenantUserParam = {
      email: userInfo.email,
      attributes: convertedUserAttributeValues,
    };

    // Add SaaS user as tenant user
    const tenantUserResponse = await authClient.tenantUserApi.createTenantUser(
      tenantId,
      createTenantUserParam
    );
    const tenantUser = tenantUserResponse.data;

    // Create role setting parameters (set as administrator)
    const createTenantUserRolesParam: CreateTenantUserRolesParam = {
      role_names: ['admin'],
    };

    // Set roles for created tenant user
    await authClient.tenantUserApi.createTenantUserRoles(
      tenantId,
      tenantUser.id,
      3, // Production environment ID
      createTenantUserRolesParam
    );

    logSuccess('self-sign-up', `Successfully created tenant: ${tenantName}`);
    return createSuccessResponse({
      message: 'User successfully signed up to the tenant',
      tenantId: tenantId,
      tenantName: tenantName,
    });
  } catch (error) {
    logError('self-sign-up', error);
    
    // Return 401 for authentication errors
    if (error instanceof Error && error.message.includes('authorization')) {
      return createErrorResponse('Authentication failed', 401, error.message);
    }
    
    return createErrorResponse(
      'Failed to sign up',
      500,
      error instanceof Error ? error.message : 'Unknown error'
    );
  }
};
```

</TabItem>
</Tabs>

### User List Retrieval API

The implementation of this API is included in the following links.
Please search for the function name or definition to find the relevant section.

- **TypeScript (Lambda)**: [`users.ts`](https://github.com/saasus-platform/implementation-sample-api-lambda/blob/main/lambda/user/users.ts)

To confirm that the API request is from a user logged into the SaaSus Platform,
please always perform a login check by retrieving user information.

<Tabs>
<TabItem value="typescript" label="TypeScript">

```typescript
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { AuthClient } from 'saasus-sdk';
import {
  createSuccessResponse,
  createErrorResponse,
  createOptionsResponse,
  getQueryParameter,
  getHttpMethod,
  logRequest,
  logError,
  logSuccess,
} from '../../shared/utils';
import { getAuthenticatedUserInfo, belongingTenant } from '../../shared/auth-utils';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  logRequest('users', event);

  // Handle OPTIONS requests (preflight)
  if (getHttpMethod(event) === 'OPTIONS') {
    return createOptionsResponse();
  }

  // Only allow GET method
  if (getHttpMethod(event) !== 'GET') {
    return createErrorResponse('Method not allowed', 405);
  }

  try {
    // Unified authentication processing
    const userInfo = await getAuthenticatedUserInfo(event.headers);

    if (!userInfo.tenants) {
      return createErrorResponse('No tenants found for the user', 400);
    }

    // Get tenant ID from query parameters
    const tenantId = getQueryParameter(event.queryStringParameters, 'tenant_id');
    if (!tenantId) {
      return createErrorResponse('TenantId not found', 400);
    }

    // Check if user belongs to the tenant
    if (!belongingTenant(userInfo.tenants, tenantId)) {
      return createErrorResponse('Tenant that does not belong', 403);
    }

    // Initialize SaaSus authentication client
    const authClient = new AuthClient();
    
    // Get tenant user list
    const usersResponse = await authClient.tenantUserApi.getTenantUsers(tenantId);
    const users = usersResponse.data.users;

    logSuccess('users', `Successfully retrieved ${users?.length || 0} users`);
    return createSuccessResponse(users);
  } catch (error) {
    logError('users', error);
    
    // Return 401 for authentication errors
    if (error instanceof Error && error.message.includes('authorization')) {
      return createErrorResponse('Authentication failed', 401, error.message);
    }
    
    return createErrorResponse(
      'Failed to get users',
      500,
      error instanceof Error ? error.message : 'Unknown error'
    );
  }
};
```

</TabItem>
</Tabs>

## Setup Instructions

### Prerequisites
- **Node.js**: 16 or higher
- **AWS CLI**: Configured
- **SaaSus Platform**: Account and project setup

### Setup Instructions

#### 1. SaaSus Platform Configuration
1. Set the post-authentication redirect URL in the SaaS development console (`http://localhost:3000/callback`)
2. Obtain the required configuration values:
   - Login screen URL
   - API keys and other authentication information

#### 2. Backend Deployment (Lambda Usage)

##### 2.1. AWS Authentication Configuration
```bash
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
# If using temporary credentials, also set:
# export AWS_SESSION_TOKEN="your-session-token"
```

##### 2.2. Backend Setup
```bash
# Clone repository
git clone https://github.com/saasus-platform/implementation-sample-api-lambda.git
cd implementation-sample-api-lambda

# Install dependencies
npm install

# Configure SaaSus environment variables
cp .env.example .env
# Set SaaSus environment variables in .env file
```

##### 2.3. Deploy
```bash
./deploy.sh
```

#### 3. Frontend Setup

##### 3.1. AWS Authentication Configuration
```bash
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
# If using temporary credentials, also set:
# export AWS_SESSION_TOKEN="your-session-token"
```

##### 3.2. Frontend Installation
```bash
# Clone repository
git clone https://github.com/saasus-platform/implementation-sample-front-react-serverless.git
cd implementation-sample-front-react-serverless

# Install dependencies
npm install
```

##### 3.3. Environment Variable Configuration
```bash
# Configure Lambda URLs
./scripts/setup-lambda-urls.sh
```

Copy the generated `.env.production` file to `.env` and set `REACT_APP_LOGIN_URL`:

```env
REACT_APP_LOGIN_URL=https://auth.xxxxxxxxxx.com
```

##### 3.4. Start
```bash
npm start
```

The app will start at `http://localhost:3000`.

#### 4. Verification
1. Access the [frontend](http://localhost:3000)
2. Verify login functionality
3. Verify each feature

For detailed setup instructions, please refer to each repository's README:
- **Frontend**: [Setup Instructions](https://github.com/saasus-platform/implementation-sample-front-react-serverless/blob/main/README.md)
- **Backend**: [Setup Instructions](https://github.com/saasus-platform/implementation-sample-api-lambda/blob/main/README.md)

### Other Implementation Approaches
For API server implementation, please refer to the following documentation:
- [Sample Application Overview](/docs/part-6/implementation-guide/sample-application/overview)